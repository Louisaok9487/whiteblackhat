<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Gray-Fox</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap');

        :root {
            --background-color: #0d0d0d;
            --text-color: #00ff41;
            --prompt-color: #00ff41;
            --input-color: #ffffff;
            --highlight-color: #faffa8;
            --error-color: #ff4d4d;
            --whitehat-color: #75aaff;
            --blackhat-color: #ff4d4d;
            --sidebar-bg: #1a1a1a;
            --sidebar-border: #333333;
            --button-bg: #333;
            --button-hover-bg: #444;
            --button-disabled-bg: #222;
            --button-disabled-color: #555;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inconsolata', monospace;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }
        
        #main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #terminal-container {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        #terminal {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #output {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .input-line {
            display: flex;
            align-items: center;
        }

        .prompt {
            color: var(--prompt-color);
            margin-right: 0.5rem;
            white-space: nowrap;
        }

        #input {
            background-color: transparent;
            border: none;
            color: var(--input-color);
            font-family: inherit;
            font-size: inherit;
            width: 100%;
            outline: none;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: var(--input-color);
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }

        @keyframes blink {
            50% { background-color: transparent; }
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 350px;
            min-width: 300px;
            background-color: var(--sidebar-bg);
            border-left: 2px solid var(--sidebar-border);
            padding: 1rem;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            border: 1px solid var(--sidebar-border);
            border-radius: 5px;
            padding: 1rem;
        }
        .sidebar-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--text-color);
            padding-bottom: 0.5rem;
            color: var(--text-color);
        }

        #status-display span, #heat-display span {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        #heat-bar-container {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--sidebar-border);
        }
        #heat-bar {
            width: 0%;
            height: 100%;
            background-color: var(--error-color);
            transition: width 0.5s ease;
        }

        .shop-item, .faction-item {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #2a2a2a;
            border-radius: 4px;
        }
        .shop-item p, .faction-item p {
            margin: 0 0 0.5rem 0;
            font-size: 0.9em;
            color: #ccc;
        }
        .shop-item button, .faction-item button {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        .shop-item button:hover, .faction-item button:hover {
            background-color: var(--button-hover-bg);
        }
        .shop-item button:disabled {
            background-color: var(--button-disabled-bg);
            color: var(--button-disabled-color);
            border-color: var(--button-disabled-color);
            cursor: not-allowed;
        }
        .owned-item {
            color: var(--highlight-color);
            font-weight: bold;
        }


        .error { color: var(--error-color); }
        .white-hat { color: var(--whitehat-color); }
        .black-hat { color: var(--blackhat-color); }
        .highlight {
            background-color: var(--text-color);
            color: var(--background-color);
            padding: 0 4px;
        }
    </style>
</head>
<body>

<div id="main-container">
    <div id="terminal-container">
        <div id="terminal">
            <div id="output"></div>
            <div class="input-line">
                <span class="prompt" id="prompt">gray-fox@local:~$</span>
                <input type="text" id="input" autofocus>
                <span class="cursor"></span>
            </div>
        </div>
    </div>
    <div id="sidebar">
        <div id="status-section" class="sidebar-section">
            <h3>Status</h3>
            <div id="status-display">
                 <span>üí∞ Money: $<span id="money">0</span></span>
                 <span>üòá White Hat: <span id="white-hat-rep">0</span></span>
                 <span>üòà Black Hat: <span id="black-hat-rep">0</span></span>
            </div>
             <div id="heat-display">
                <span>Heat Level:</span>
                <div id="heat-bar-container">
                    <div id="heat-bar"></div>
                </div>
            </div>
        </div>

        <div id="shop-section" class="sidebar-section">
            <h3>Hardware & Software Shop</h3>
            <div id="shop-items"></div>
        </div>

        <div id="faction-section" class="sidebar-section">
            <h3 id="faction-title">Faction Access</h3>
            <div id="faction-content">
                <p>Your reputation is not yet strong enough to attract the attention of major factions.</p>
            </div>
        </div>
    </div>
</div>


<script>
    // --- DOM Elements ---
    const terminal = document.getElementById('terminal');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const promptEl = document.getElementById('prompt');
    const moneyEl = document.getElementById('money');
    const whiteHatRepEl = document.getElementById('white-hat-rep');
    const blackHatRepEl = document.getElementById('black-hat-rep');
    const heatBar = document.getElementById('heat-bar');
    const shopItemsContainer = document.getElementById('shop-items');
    const factionContent = document.getElementById('faction-content');
    const factionTitle = document.getElementById('faction-title');


    // --- Game State ---
    let commandHistory = [];
    let historyIndex = -1;
    let gameState = {
        money: 500, // Start with some seed money
        whiteHatRep: 0,
        blackHatRep: 0,
        heat: 0, // 0-100 scale
        currentMission: null,
        inMinigame: false,
        minigameCallback: null,
        upgrades: {
            cpuLevel: 1,
            ramLevel: 1,
            hasPremiumScanner: false,
            hasVpn: false,
            wordlistLevel: 1, // 1: basic, 2: rockyou
        },
        inventory: {
            zeroDayExploits: 0
        },
        // --- Mission Database ---
        missions: {
            // Original Missions
            "mission_01": { id: "mission_01", faction: "white", repRequirement: 0, type: "sql_injection", title: "Vulnerability Assessment for OmniCorp", client: "OmniCorp", targetIp: "192.168.1.101", completed: false, mail: `...` },
            "mission_02": { id: "mission_02", faction: "white", repRequirement: 0, type: "social_engineering", title: "Employee Security Awareness Test", client: "CyberRight Inc.", target: "TechSolutions LLC", completed: false, mail: `...` },
            "mission_03": { id: "mission_03", faction: "black", repRequirement: 0, type: "data_theft", title: "Acquire Competitor's Project Files", client: "Anonymous", targetIp: "203.0.113.78", completed: false, mail: `...` },
            "mission_04": { id: "mission_04", faction: "white", repRequirement: 1, type: "wifi_cracking", title: "Coffee Shop WiFi Test", client: "The Daily Grind Cafe", target: "GrindNet_Guest", completed: false, mail: `...` },
            "mission_05": { id: "mission_05", faction: "white", repRequirement: 2, type: "phishing", title: "Corporate Phishing Drill", client: "Securitas Corp", target: "MegaCorp Inc.", completed: false, mail: `...` },
            "mission_06": { id: "mission_06", faction: "black", repRequirement: 2, type: "physical_hacking", title: "USB Drop", client: "Anonymous Client", target: "Rival Corp HQ", completed: false, mail: `...` },
            "mission_07": { id: "mission_07", faction: "white", repRequirement: 3, type: "network_sniffing", title: "Internal Data Leak Investigation", client: "Fintech Solutions", targetIp: "10.10.5.15", completed: false, mail: `...` },
            "mission_08": { id: "mission_08", faction: "white", repRequirement: 4, type: "ai_adversarial", title: "Test AI Security System", client: "Cerebrum AI", target: "Cerebrum GuardAI", completed: false, mail: `...` },
            "mission_09": { id: "mission_09", faction: "black", repRequirement: 3, type: "ransomware", title: "Ransomware Deployment", client: "DarkNet Syndicate", targetIp: "172.16.30.120", completed: false, mail: `...` },
            "mission_10": { id: "mission_10", faction: "black", repRequirement: 1, type: "dos_attack", title: "Tournament Disruption", client: "Salty Gamers Crew", targetIp: "198.51.100.45", completed: false, mail: `...` },
            "mission_11": { id: "mission_11", faction: "black", repRequirement: 4, type: "password_cracking", title: "Crack the Database", client: "Data Brokers Inc.", target: "leaked_db.hash", completed: false, mail: `...` },
            "mission_12": { id: "mission_12", faction: "black", repRequirement: 5, type: "mobile_hacking", title: "Targeted Surveillance", client: "Gov Agency [CLASSIFIED]", target: "Journalist", completed: false, mail: `...` },
            "mission_13": { id: "mission_13", faction: "white", repRequirement: 5, type: "cloud_hacking", title: "Cloud Storage Audit", client: "StartUp Innovations", target: "startup-innovations.com", completed: false, mail: `...` },
            
            // New Detailed Missions
            "mission_14": { id: "mission_14", faction: "black", repRequirement: 6, type: "supply_chain", title: "Supply Chain Compromise", client: "The Syndicate", target: "popular_dev_tool", completed: false, mail: `...` },
            "mission_15": { id: "mission_15", faction: "black", repRequirement: 5, type: "bec_attack", title: "Business Email Compromise", client: "Anonymous", target: "Finance Dept", completed: false, mail: `...` },
            "mission_16": { id: "mission_16", faction: "white", repRequirement: 4, type: "iot_hacking", title: "Smart Home Security Test", client: "HomeSecure Inc.", target: "SmartLock_Pro", completed: false, mail: `...` },
            "mission_17": { id: "mission_17", faction: "black", repRequirement: 3, type: "insider_threat", title: "Corporate Sabotage", client: "Rival Corp", target: "TargetSys Inc.", completed: false, mail: `...` },
            "mission_18": { id: "mission_18", faction: "white", repRequirement: 2, type: "smishing_attack", title: "Smishing Awareness Campaign", client: "MobileGuard", target: "General Public", completed: false, mail: `...` },
            "mission_19": { id: "mission_19", faction: "black", repRequirement: 4, type: "credential_stuffing", title: "Account Takeover", client: "DataThieves", target: "MegaBank", completed: false, mail: `...` },
            "mission_20": { id: "mission_20", faction: "white", repRequirement: 6, type: "dns_spoofing", title: "DNS Hijacking Test", client: "NetPatrol Corp", target: "e-shop.com", completed: false, mail: `...` },
            "mission_21": { id: "mission_21", faction: "white", repRequirement: 7, type: "api_hacking", title: "API Security Audit", client: "ConnectAPI", target: "api.connectapi.com", completed: false, mail: `...` },
            "mission_22": { id: "mission_22", faction: "black", repRequirement: 8, type: "fileless_malware", title: "Undetectable Attack", client: "GhostCell", target: "SecureCorp", completed: false, mail: `...` },
            "mission_23": { id: "mission_23", faction: "black", repRequirement: 2, type: "cryptojacking", title: "Resource Acquisition", client: "Anonymous", target: "University Network", completed: false, mail: `...` }
        }
    };
    // Fill in mission mail content
    Object.values(gameState.missions).forEach(m => {
        const fullMission = getFullMissionDetails(m.id);
        m.mail = fullMission.mail;
    });


    // --- Shop & Faction Data ---
    const shopData = {
        'cpu2': { name: 'CPU Upgrade (Lvl 2)', cost: 2500, description: 'Speeds up cracking tasks.', type: 'upgrade', key: 'cpuLevel', value: 2 },
        'cpu3': { name: 'CPU Upgrade (Lvl 3)', cost: 10000, description: 'Dramatically speeds up cracking.', type: 'upgrade', key: 'cpuLevel', value: 3, requires: {key: 'cpuLevel', value: 2} },
        'scanner': { name: 'Premium Scanner', cost: 4000, description: 'Reveals hidden vulnerabilities.', type: 'upgrade', key: 'hasPremiumScanner', value: true },
        'wordlist2': { name: 'Advanced Wordlist', cost: 1500, description: 'Improves dictionary attacks.', type: 'upgrade', key: 'wordlistLevel', value: 2 },
        'vpn': { name: 'Anonymizer VPN', cost: 5000, description: 'Reduces Heat from black hat jobs.', type: 'upgrade', key: 'hasVpn', value: true },
    };

    const factionData = {
        white: {
            name: "Cybersecurity Alliance",
            items: {
                'intel': { name: 'Buy Mission Intel', cost: 2000, description: 'Get a hint for your current mission.' }
            }
        },
        black: {
            name: "The DarkNet",
            items: {
                'zeroday': { name: 'Buy Zero-Day Exploit', cost: 25000, description: 'A single-use, guaranteed exploit.' },
                'botnet': { name: 'Rent Botnet', cost: 7000, description: 'Boosts DoS attack effectiveness.' }
            }
        }
    }

    // --- Core Game Logic ---
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const command = input.value.trim();
            if (command) {
                printToOutput(`<span class="prompt">${promptEl.textContent}</span> ${command}`);
                handleCommand(command);
                commandHistory.unshift(command);
                historyIndex = -1;
                input.value = '';
                scrollToBottom();
            }
        } else if (e.key === 'ArrowUp') {
            if (historyIndex < commandHistory.length - 1) { historyIndex++; input.value = commandHistory[historyIndex]; }
        } else if (e.key === 'ArrowDown') {
            if (historyIndex > 0) { historyIndex--; input.value = commandHistory[historyIndex]; } 
            else { historyIndex = -1; input.value = ''; }
        }
    });

    terminal.addEventListener('click', () => { input.focus(); });

    function handleCommand(command) {
        const [cmd, ...args] = command.toLowerCase().split(' ');

        if (cmd === 'help') { showHelp(); return; }
        if (cmd === 'clear') { output.innerHTML = ''; return; }
        
        if (gameState.inMinigame) {
            if (gameState.minigameCallback) gameState.minigameCallback(command);
            return;
        }

        switch (cmd) {
            case 'whoami': printToOutput('User: gray-fox üßë‚Äçüíª'); break;
            case 'mail': checkMail(); break;
            case 'scan': runScan(args[0]); break;
            case 'exploit': runExploit(args[0], args[1]); break;
            case 'report': runReport(); break;
            case 'exploit_data': runExploitData(); break;
            case 'social_eng': startSocialEngineeringMinigame(args[0]); break;
            case 'scan_wifi': startWifiScan(); break;
            case 'crack_wpa2': startWifiCrack(args[0]); break;
            case 'craft_phish': startPhishingMinigame(); break;
            case 'infiltrate': startPhysicalHackingMinigame(args[0]); break;
            case 'sniff_traffic': startNetworkSniffing(args[0]); break;
            case 'access_ai_lab': startAiMinigame(); break;
            case 'initiate_botnet': startDosMinigame(); break;
            case 'crack_hashes': startPasswordCrack(args[0]); break;
            case 'develop_app': startMobileHacking(); break;
            case 'scan_cloud': startCloudScan(args[0]); break;
            // New commands for new missions
            case 'compromise_repo': startSupplyChainAttack(); break;
            case 'initiate_bec': startBecAttack(); break;
            case 'scan_iot': startIotScan(args[0]); break;
            case 'access_internal': startInsiderThreat(); break;
            case 'launch_smish': startSmishingAttack(); break;
            case 'stuff_creds': startCredentialStuffing(); break;
            case 'poison_dns': startDnsSpoofing(); break;
            case 'fuzz_api': startApiHacking(); break;
            case 'inject_memory': startFilelessMalware(); break;
            case 'deploy_miner': startCryptojacking(); break;
            default: printToOutput(`<span class="error">Command not found: ${cmd}. Type 'help' for a list of commands.</span>`);
        }
    }

    // --- Command Functions ---
    function showHelp() {
        const helpText = `
Project Gray-Fox Help:
  <span class="highlight">help</span>                 - Shows this help message.
  <span class="highlight">clear</span>                - Clears the terminal screen.
  <span class="highlight">whoami</span>               - Displays your current user.
  <span class="highlight">mail</span>                 - Checks for new messages and missions.
  <span class="highlight">scan [ip]</span>              - Scans a target IP for vulnerabilities.
  <span class="highlight">exploit [vuln]</span>         - Attempts to exploit a found vulnerability.
  <span class="highlight">report</span>                 - Report vulnerability to client (White Hat).
  <span class="highlight">exploit_data</span>           - Steal data for profit (Black Hat).

Mission-specific commands will be provided in mission briefings.
Check the sidebar on the right to purchase upgrades and access faction services.
        `;
        printToOutput(helpText.replace(/\n/g, '<br>'));
    }
    
    function checkMail() {
        if (gameState.currentMission) {
            printToOutput("You already have an active mission. Complete it first.");
            return;
        }

        const dominantRep = gameState.whiteHatRep > gameState.blackHatRep ? 'white' : 'black';
        const repScore = Math.max(gameState.whiteHatRep, gameState.blackHatRep);

        const availableMissions = Object.values(gameState.missions).filter(m => 
            !m.completed &&
            m.repRequirement <= repScore &&
            (m.faction === dominantRep || m.faction === 'neutral' || repScore === 0)
        );

        if (availableMissions.length === 0) {
            printToOutput("No new messages matching your reputation. Try completing different types of jobs.");
            return;
        }

        const mission = availableMissions[Math.floor(Math.random() * availableMissions.length)];
        gameState.currentMission = mission.id;
        
        const mailText = `New Message (1):${mission.mail}`;
        typewriterEffect(mailText);
    }
    
    function runScan(targetIp) {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || !targetIp || targetIp !== mission.targetIp) { 
            printToOutput(`<span class="error">Error: No active mission or invalid target IP.</span>`);
            return;
        }

        let scanText = `Scanning ${targetIp} with scanner v${gameState.upgrades.cpuLevel}.0...`;
        if(gameState.upgrades.hasPremiumScanner) {
            scanText += `\n<span class="white-hat">[Premium Scanner]: Deep scan enabled.</span>`
        }
        
        if (mission.type === 'sql_injection') {
            scanText += `\n[!] Potential SQL Injection vulnerability detected on login form!`;
        } else if (mission.type === 'ransomware') {
             scanText += `\n[!] Found an unpatched SMBv1 vulnerability (EternalBlue).`;
             if(gameState.upgrades.hasPremiumScanner) {
                 scanText += `\n<span class="white-hat">[Premium Scanner]: Also found an exposed RDP port (3389).</span>`;
             }
        } else {
             scanText += `\nNo obvious vulnerabilities found.`;
        }
        typewriterEffect(scanText);
    }

    function completeMission(money, whiteHat, blackHat) {
        gameState.money += money;
        gameState.whiteHatRep += whiteHat;
        gameState.blackHatRep += blackHat;
        
        if (blackHat > 0) {
            let heatIncrease = 15;
            if(gameState.upgrades.hasVpn) {
                heatIncrease = 5;
                printToOutput(`<span class="white-hat">Anonymizer VPN routed traffic, heat reduced.</span>`);
            }
            gameState.heat = Math.min(100, gameState.heat + heatIncrease);
        } else if (whiteHat > 0) {
            gameState.heat = Math.max(0, gameState.heat - 5);
        }
        
        if(gameState.currentMission) {
            gameState.missions[gameState.currentMission].completed = true;
            gameState.currentMission = null;
        }
        
        printToOutput("<br>Mission Completed! Check 'mail' for new assignments.");
        updateSidebar();
        checkHeat();
    }
    
    // --- Sidebar & Shop Logic ---

    function updateSidebar() {
        moneyEl.textContent = gameState.money.toLocaleString();
        whiteHatRepEl.textContent = gameState.whiteHatRep;
        blackHatRepEl.textContent = gameState.blackHatRep;
        heatBar.style.width = `${gameState.heat}%`;

        shopItemsContainer.innerHTML = '';
        for (const id in shopData) {
            const item = shopData[id];
            const isOwned = gameState.upgrades[item.key] >= item.value;
            const canAfford = gameState.money >= item.cost;
            const meetsRequirement = !item.requires || (gameState.upgrades[item.requires.key] >= item.requires.value);

            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            
            let html = `<strong>${item.name}</strong>`;
            if (isOwned) {
                html += ` <span class="owned-item">[OWNED]</span>`;
            } else {
                html += ` - <span class="highlight">$${item.cost.toLocaleString()}</span>`;
            }
            html += `<p>${item.description}</p>`;
            
            const buyButton = document.createElement('button');
            buyButton.textContent = 'Buy';
            buyButton.disabled = isOwned || !canAfford || !meetsRequirement;
            if (!meetsRequirement) {
                buyButton.textContent = 'Requirement not met';
            }
            buyButton.onclick = () => buyItem(id, 'shop');

            itemDiv.innerHTML = html;
            if(!isOwned) itemDiv.appendChild(buyButton);
            shopItemsContainer.appendChild(itemDiv);
        }

        const whRep = gameState.whiteHatRep;
        const bhRep = gameState.blackHatRep;
        let activeFaction = null;

        if (whRep > bhRep && whRep >= 3) {
            activeFaction = 'white';
        } else if (bhRep > whRep && bhRep >= 3) {
            activeFaction = 'black';
        }

        if (activeFaction) {
            const data = factionData[activeFaction];
            factionTitle.textContent = data.name;
            factionContent.innerHTML = '';
            for (const id in data.items) {
                const item = data.items[id];
                const canAfford = gameState.money >= item.cost;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'faction-item';
                itemDiv.innerHTML = `
                    <strong>${item.name}</strong> - <span class="highlight">$${item.cost.toLocaleString()}</span>
                    <p>${item.description}</p>
                    <button ${!canAfford ? 'disabled' : ''} onclick="buyItem('${id}', '${activeFaction}')">Purchase</button>
                `;
                factionContent.appendChild(itemDiv);
            }
        } else {
            factionTitle.textContent = 'Faction Access';
            factionContent.innerHTML = '<p>Your reputation is not yet strong enough to attract the attention of major factions.</p>';
        }
    }

    function buyItem(itemId, type) {
        const item = type === 'shop' ? shopData[itemId] : factionData[type].items[itemId];
        if (!item || gameState.money < item.cost) {
            printToOutput(`<span class="error">Purchase failed. Insufficient funds.</span>`);
            return;
        }

        gameState.money -= item.cost;
        
        if (item.type === 'upgrade') {
            gameState.upgrades[item.key] = item.value;
        } else {
            switch(itemId) {
                case 'zeroday':
                    gameState.inventory.zeroDayExploits++;
                    break;
            }
        }

        printToOutput(`Purchase successful: <span class="highlight">${item.name}</span>`);
        updateSidebar();
    }
    
    function checkHeat() {
        if (gameState.heat > 80 && Math.random() < 0.25) {
            typewriterEffect(`<span class="error">** ALERT ** Unusual network traffic detected on your connection! The Feds might be closing in. Lay low for a while.</span>`);
        }
    }

    // --- Helper Functions ---
    function printToOutput(html) {
        output.innerHTML += `<div>${html}</div>`;
        scrollToBottom();
    }

    function scrollToBottom() {
        output.scrollTop = output.scrollHeight;
    }
    
    function typewriterEffect(text, onComplete) {
        const lines = text.replace(/^\n+/, '').replace(/\n/g, '<br>').split('<br>');
        let lineIndex = 0;
        input.disabled = true;

        function printLine() {
            if (lineIndex < lines.length) {
                printToOutput(lines[lineIndex]);
                lineIndex++;
                setTimeout(printLine, 20 + Math.random() * 30);
            } else {
                input.disabled = false;
                input.focus();
                if (onComplete) onComplete();
            }
        }
        printLine();
    }

    // --- All Minigame and Command Functions ---
    // This section contains all mission logic.
    
    const runReport = () => typewriterEffect(`Generating report...`, () => completeMission(5000, 1, 0));
    const runExploitData = () => typewriterEffect(`Exploiting data...`, () => completeMission(15000, 0, 1));
    const runExploit = () => typewriterEffect(`<span class="error">Invalid exploit command.</span>`);
    const startSocialEngineeringMinigame = () => typewriterEffect(`Starting social engineering...`, () => completeMission(7500, 1, 0));
    const startSqlInjectionMinigame = () => typewriterEffect(`Starting SQL injection...`, () => completeMission(5000, 1, 0));
    const startWifiScan = () => typewriterEffect(`Scanning for WiFi...`, () => completeMission(0,0,0));
    const startWifiCrack = () => typewriterEffect(`Cracking WPA2...`, () => completeMission(3000, 1, 0));
    const startPhishingMinigame = () => typewriterEffect(`Crafting phishing email...`, () => completeMission(6000, 1, 0));
    const startPhysicalHackingMinigame = () => typewriterEffect(`Infiltrating...`, () => completeMission(20000, 0, 1));
    const startNetworkSniffing = () => typewriterEffect(`Sniffing traffic...`, () => completeMission(8000, 1, 0));
    const startAiMinigame = () => typewriterEffect(`Accessing AI lab...`, () => completeMission(15000, 1, 0));
    const startDosMinigame = () => typewriterEffect(`Initiating botnet...`, () => completeMission(9000, 0, 1));
    const startPasswordCrack = () => typewriterEffect(`Cracking hashes...`, () => completeMission(18000, 0, 1));
    const startMobileHacking = () => typewriterEffect(`Developing trojan app...`, () => completeMission(45000, 0, 1));
    const startCloudScan = () => typewriterEffect(`Scanning cloud storage...`, () => completeMission(8000, 1, 0));

    // --- NEW DETAILED MINIGAMES ---
    function startSupplyChainAttack() {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'supply_chain') { return; }
        gameState.inMinigame = true;
        const text = `
--- Supply Chain Attack ---
You've gained access to the public code repository for '<span class="highlight">${mission.target}</span>'.
Your goal is to inject a malicious payload into the source code that will be distributed in the next update.
Choose your injection point:
  1) The main application entry point (obvious, likely to be caught).
  2) A rarely used legacy library dependency (stealthy).
  3) The build script that compiles the final program (clever, hard to spot).
        `;
        printToOutput(text.replace(/\n/g, '<br>'));
        gameState.minigameCallback = (choice) => {
            gameState.inMinigame = false;
            gameState.minigameCallback = null;
            if (choice === '3') {
                typewriterEffect(`
Injecting payload into build script...
Creating pull request with a vague description: "Minor build optimizations"...
...Pull request accepted and merged by an unsuspecting developer!
The payload is now in the main branch.
<span class="highlight">Compromise successful.</span> The next update will carry your malware.
Payment transferred from The Syndicate.
<span class="highlight">Payment received: $75,000</span>
<span class="black-hat">Reputation changed: Black Hat +2 üòà</span>
                `, () => completeMission(75000, 0, 2));
            } else {
                typewriterEffect(`<span class="error">Your commit triggered a security alert!</span> The repository maintainers have reverted your changes and banned your account. Mission failed.`, () => completeMission(0, 0, 0));
            }
        };
    }

    function startBecAttack() {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'bec_attack') { return; }
        gameState.inMinigame = true;
        const text = `
--- Business Email Compromise ---
You've been monitoring the CFO of a major corporation. You've registered a domain that looks very similar to their main partner's domain (e.g., 'megacorp.com' vs 'megac0rp.com').
You must now craft an email to the CFO's assistant, pretending to be the CFO, authorizing an urgent wire transfer.
What is the key element of your email?
  1) "URGENT - INVOICE PAYMENT - SEND $250,000 NOW" (Too aggressive)
  2) "Hi, I'm stuck in meetings. Can you please process invoice #78-A for our partner at MegaC0rp? It's overdue. Thanks." (Plausible)
  3) "This is the CEO. Send money." (Not believable)
        `;
        printToOutput(text.replace(/\n/g, '<br>'));
        gameState.minigameCallback = (choice) => {
            gameState.inMinigame = false;
            gameState.minigameCallback = null;
            if (choice === '2') {
                typewriterEffect(`
Email sent. You wait...
...An hour later, you see a transaction notification. The assistant took the bait.
The wire transfer was successful.
<span class="highlight">Funds acquired.</span>
<span class="highlight">Payment received: $250,000</span>
<span class="black-hat">Reputation changed: Black Hat +2 üòà</span>
                `, () => completeMission(250000, 0, 2));
            } else {
                typewriterEffect(`<span class="error">The assistant found your request suspicious</span> and called the CFO to verify. The alarm has been raised. Mission failed.`, () => completeMission(0, 0, 0));
            }
        };
    }

    function startIotScan(target) {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'iot_hacking') { return; }
        typewriterEffect(`Scanning for IoT devices on the network...\nFound device: <span class="highlight">${mission.target}</span>\nQuerying for default credentials...`);
        setTimeout(() => {
            typewriterEffect(`
<span class="highlight">Vulnerability found!</span> The device is using the default factory password ('admin123').
You can now access the device's control panel.
What's your next move?
  - <span class="highlight">report</span>: Report the critical vulnerability to HomeSecure Inc. (White Hat)
  - <span class="highlight">exploit_data</span>: Unlock the door and sell access to a burglary crew. (Black Hat)
            `);
        }, 2000);
    }
    
    function startApiHacking() {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'api_hacking') { return; }
        gameState.inMinigame = true;
        const text = `
--- API Hacking Minigame ---
You are auditing the endpoint <span class="highlight">/api/v1/user/details/{userID}</span>.
You notice that by requesting your own userID, you get your user details.
What is the next logical test for a vulnerability?
  1) Try to POST data to the endpoint.
  2) Change the request from GET to DELETE.
  3) Replace your userID with another number (e.g., 1, 100, 101) to see if you can access other users' data.
        `;
        printToOutput(text.replace(/\n/g, '<br>'));
        gameState.minigameCallback = (choice) => {
            gameState.inMinigame = false;
            gameState.minigameCallback = null;
            if (choice === '3') {
                typewriterEffect(`
You send a request to <span class="highlight">/api/v1/user/details/1</span>...
<span class="highlight">Success!</span> The API returns the full details for the system's first-ever user: the administrator.
This is a classic Insecure Direct Object Reference (IDOR) vulnerability.
You have proven a critical flaw.
<span class="highlight">Payment received: $22,000</span>
<span class="white-hat">Reputation changed: White Hat +2 üòá</span>
                `, () => completeMission(22000, 2, 0));
            } else {
                typewriterEffect(`<span class="error">The API returns a 405 Method Not Allowed error.</span> That's not the vulnerability. Mission failed.`, () => completeMission(0, 0, 0));
            }
        };
    }
    
    function startFilelessMalware() {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'fileless_malware') { return; }
        gameState.inMinigame = true;
        const text = `
--- Fileless Malware Attack ---
You have a foothold in SecureCorp's network. To avoid antivirus, you must run your payload only in memory.
Which legitimate system tool will you abuse to run your malicious code?
  1) notepad.exe (A simple text editor, no code execution capabilities)
  2) powershell.exe (A powerful scripting engine, perfect for this)
  3) mspaint.exe (An image editor, cannot run scripts)
        `;
        printToOutput(text.replace(/\n/g, '<br>'));
        gameState.minigameCallback = (choice) => {
            gameState.inMinigame = false;
            gameState.minigameCallback = null;
            if (choice === '2') {
                typewriterEffect(`
You use PowerShell to download and execute your script directly into RAM.
<span class="highlight">Executing from memory...</span>
Antivirus scan... <span class="white-hat">Clean.</span> No malicious files found on disk.
The payload is running undetected, siphoning data.
The client is extremely pleased with your stealth.
<span class="highlight">Payment received: $120,000</span>
<span class="black-hat">Reputation changed: Black Hat +3 üòà</span>
                `, () => completeMission(120000, 0, 3));
            } else {
                typewriterEffect(`<span class="error">That tool cannot execute your script.</span> You have lost your foothold. Mission failed.`, () => completeMission(0, 0, 0));
            }
        };
    }

    const unimplemented = () => typewriterEffect(`<span class="error">This path is still under development.</span>`, () => completeMission(0,0,0));
    const startInsiderThreat = unimplemented, startSmishingAttack = unimplemented, startCredentialStuffing = unimplemented, startDnsSpoofing = unimplemented, startCryptojacking = unimplemented;


    // --- Game Start ---
    function startGame() {
        const welcomeMessage = `
Booting Gray-Fox OS v3.1...
Kernel loaded.
Hardware monitor initialized.
Network connection secured... OK

Welcome, Gray-Fox üßë‚Äçüíª

Type <span class="highlight">help</span> for a list of available commands.
Type <span class="highlight">mail</span> to check for assignments.
        `;
        updateSidebar();
        typewriterEffect(welcomeMessage);
    }
    
    function getFullMissionDetails(id) {
        const missionMails = {
            "mission_01": { mail: `...`}, "mission_02": { mail: `...`}, "mission_03": { mail: `...`}, "mission_04": { mail: `...`}, "mission_05": { mail: `...`}, "mission_06": { mail: `...`}, "mission_07": { mail: `...`}, "mission_08": { mail: `...`}, "mission_09": { mail: `...`}, "mission_10": { mail: `...`}, "mission_11": { mail: `...`}, "mission_12": { mail: `...`}, "mission_13": { mail: `...`},
            "mission_14": { mail: `\nFrom: syndicate-ops@darknet.onion\nTo: gray-fox\nSubject: A Delicate Operation\n\nWe need you to compromise a popular developer utility, 'CodeHelper.js'. Their update server is your target. Inject our payload into their next software update to create a botnet.\nUse <span class="highlight">compromise_repo</span> to begin.`},
            "mission_15": { mail: `\nFrom: [REDACTED]\nTo: gray-fox\nSubject: Wire Transfer\n\nWe've identified a corporate target ripe for a Business Email Compromise. You need to impersonate the CEO and authorize a fraudulent wire transfer. Plausibility is key.\nUse <span class="highlight">initiate_bec</span> to start.`},
            "mission_16": { mail: `\nFrom: contact@homesecure.io\nTo: gray-fox\nSubject: IoT Device Pen Test\n\nWe're launching a new smart lock, the 'SmartLock_Pro'. We need you to test its security against common attacks. See if you can bypass its authentication.\nUse <span class="highlight">scan_iot [ip]</span> on the test network.`},
            "mission_17": { mail: `\nFrom: [ENCRYPTED]\nTo: gray-fox\nSubject: Insider Access\n\nWe've paid off a disgruntled employee at TargetSys Inc. They've given you their credentials and a 1-hour window to access their internal network and plant a data-wiper virus.\nUse <span class="highlight">access_internal</span> to login.`},
            "mission_18": { mail: `\nFrom: awareness@mobileguard.com\nTo: gray-fox\nSubject: Smishing Campaign\n\nWe need you to run a smishing (SMS phishing) campaign to test public awareness. Craft a convincing text message to harvest credentials for our report.\nUse <span class="highlight">launch_smish</span> to begin.`},
            "mission_19": { mail: `\nFrom: datathieves@proton.me\nTo: gray-fox\nSubject: Account Lists\n\nWe have a list of email/password combos from the recent 'SocialVerse' breach. We need you to run a credential stuffing attack against MegaBank to see how many accounts you can take over.\nUse <span class="highlight">stuff_creds</span>.`},
            "mission_20": { mail: `\nFrom: pentest@netpatrol.corp\nTo: gray-fox\nSubject: DNS Security Audit\n\nWe need you to perform a DNS cache poisoning attack against our test domain, 'e-shop.com', to see if you can redirect users to a malicious IP. This is a high-skill contract.\nUse <span class="highlight">poison_dns</span>.`},
            "mission_21": { mail: `\nFrom: security@connectapi.com\nTo: gray-fox\nSubject: API Pen Test\n\nOur developers have just deployed a new user API. We need you to audit it for common vulnerabilities, specifically related to authorization and data exposure.\nUse <span class="highlight">fuzz_api</span> on the endpoint.`},
            "mission_22": { mail: `\nFrom: ghostcell@proton.me\nTo: gray-fox\nSubject: Untraceable\n\nWe need you to exfiltrate data from a highly secure corporate network. The catch: you cannot write any files to the disk. The entire attack must be fileless, running only in memory.\nUse <span class="highlight">inject_memory</span>.`},
            "mission_23": { mail: `\nFrom: [REDACTED]\nTo: gray-fox\nSubject: Passive Income\n\nA university has a massive computer lab with hundreds of powerful machines that are idle at night. We want you to deploy a silent cryptominer to use their resources to mine Monero for us.\nUse <span class="highlight">deploy_miner</span>.`}
        };
        const mission = missionMails[id];
        // Fill in mail for original missions if they are empty
        if (mission && mission.mail === '...') {
             const originalMails = {
                "mission_01": { mail: `\nFrom: contact@omnicorp.sec\nTo: gray-fox\nSubject: Urgent: Security Assessment Required\n\nWe require your services for a penetration test on one of our web servers. We suspect a potential vulnerability in our login system.\nTarget IP: <span class="highlight">192.168.1.101</span>\nYour task is to assess the system and report any findings.\n`},
                "mission_02": { mail: `\nFrom: security@cyberright.inc\nTo: gray-fox\nSubject: Contract: Social Engineering Test\n\nGray-Fox, we need you to test the human element at TechSolutions LLC.\nYour task is to acquire an admin password via phone (vishing).\nTarget: TechSolutions Help Desk.\nUse command <span class="highlight">social_eng TSL_HelpDesk</span> to initiate the call.\n`},
                "mission_03": { mail: `\nFrom: [REDACTED]\nTo: gray-fox\nSubject: A Lucrative Opportunity\n\nWe need access to the prototype files on Innovatech's internal server.\nTheir security is weak. Get in, get the files, get out.\nIP: <span class="highlight">203.0.113.78</span>\nDiscretion is key. Payment will be substantial.\n`},
                "mission_04": { mail: `\nFrom: owner@dailygrind.cafe\nTo: gray-fox\nSubject: Security check on our Guest WiFi\n\nHi, we'd like to hire you to check if our guest WiFi is secure.\nThe network name is <span class="highlight">GrindNet_Guest</span>.\nPlease see if you can get the password and let us know.\nUse <span class="highlight">scan_wifi</span> to begin.\n`},
                "mission_05": { mail: `\nFrom: audit@securitas.corp\nTo: gray-fox\nSubject: Phishing Susceptibility Audit\n\nWe need you to conduct a phishing drill on employees at MegaCorp Inc.\nYour goal is to see how many credentials you can capture.\nUse <span class="highlight">craft_phish</span> to design the attack email.\n`},
                "mission_06": { mail: `\nFrom: [ENCRYPTED]\nTo: gray-fox\nSubject: Physical Infiltration\n\nWe need you to plant a 'special' USB drive somewhere inside Rival Corp's main office.\nSomeone is bound to pick it up. The drive will do the rest.\nUse <span class="highlight">infiltrate Rival_Corp_HQ</span> to begin the operation.\n`},
                "mission_07": { mail: `\nFrom: cso@fintech.sol\nTo: gray-fox\nSubject: Suspected Insider Threat\n\nWe believe an employee is exfiltrating sensitive client data.\nWe need you to monitor traffic from their workstation at <span class="highlight">10.10.5.15</span> and find proof.\nUse <span class="highlight">sniff_traffic 10.10.5.15</span> to start monitoring.\n`},
                "mission_08": { mail: `\nFrom: labs@cerebrum.ai\nTo: gray-fox\nSubject: Adversarial Attack Challenge\n\nWe've built the world's most advanced AI-powered facial recognition security. We challenge you to fool it.\nYour task is to get past our system by making it misclassify you.\nUse <span class="highlight">access_ai_lab</span> to begin the test.\n`},
                "mission_09": { mail: `\nFrom: syndicate-boss@darknet.onion\nTo: gray-fox\nSubject: Job Offer: High Reward\n\nA local clinic has weak security. A perfect target.\nDeploy our ransomware on their server at <span class="highlight">172.16.30.120</span>.\nThe payout will be huge. Use <span class="highlight">scan [ip]</span> to find an entry point.\n`},
                "mission_10": { mail: `\nFrom: l33th4x@saltygamers.net\nTo: gray-fox\nSubject: Take 'em down!\n\nThe 'Pro Gamers United' team needs to be taken offline during the championship match tonight.\nTheir game server is at <span class="highlight">198.51.100.45</span>.\nWe'll pay you well to flood their server.\nUse <span class="highlight">initiate_botnet</span> to get started.\n`},
                "mission_11": { mail: `\nFrom: acquisitions@databrokers.inc\nTo: gray-fox\nSubject: Hashed Password File\n\nWe've acquired a user database from the recent 'SocialSphere' breach.\nThe passwords are all hashed. We need you to crack them.\nThe file is named <span class="highlight">leaked_db.hash</span>.\nUse <span class="highlight">crack_hashes leaked_db.hash</span> to begin.\n`},
                "mission_12": { mail: `\nFrom: agent.k@gov.sec\nTo: gray-fox\nSubject: National Security Matter\n\nWe require your expertise to monitor a person of interest.\nYou are to develop a trojan application and convince the target, a journalist, to install it on their phone.\nUse <span class="highlight">develop_app</span> to start.\n`},
                "mission_13": { mail: `\nFrom: ceo@startup-innovations.com\nTo: gray-fox\nSubject: Urgent Cloud Security Audit\n\nWe're worried we might have misconfigured our cloud storage and exposed customer data.\nPlease audit our storage buckets, linked to our domain <span class="highlight">startup-innovations.com</span>.\nUse <span class="highlight">scan_cloud startup-innovations.com</span> to check for open buckets.\n`}
             }
             return originalMails[id] || { mail: "Error: Mail not found." };
        }
        return mission || { mail: "Error: Mail not found." };
    }
    
    startGame();
</script>
</body>
</html>
