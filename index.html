<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Gray-Fox</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap');

        :root {
            --background-color: #0d0d0d;
            --text-color: #00ff41;
            --prompt-color: #00ff41;
            --input-color: #ffffff;
            --highlight-color: #faffa8;
            --error-color: #ff4d4d;
            --whitehat-color: #75aaff;
            --blackhat-color: #ff4d4d;
            --sidebar-bg: #1a1a1a;
            --sidebar-border: #333333;
            --button-bg: #333;
            --button-hover-bg: #444;
            --button-disabled-bg: #222;
            --button-disabled-color: #555;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inconsolata', monospace;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }
        
        #main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #terminal-container {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        #terminal {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        #terminal .prompt { color: var(--prompt-color); }
        #terminal #input { color: var(--input-color); }
        #terminal .cursor { background-color: var(--input-color); }


        #output {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .input-line {
            display: flex;
            align-items: center;
        }

        .prompt {
            margin-right: 0.5rem;
            white-space: nowrap;
        }

        #input {
            background-color: transparent;
            border: none;
            font-family: inherit;
            font-size: inherit;
            width: 100%;
            outline: none;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }

        @keyframes blink {
            50% { background-color: transparent; }
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 350px;
            min-width: 300px;
            background-color: var(--sidebar-bg);
            border-left: 2px solid var(--sidebar-border);
            padding: 1rem;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar-tabs {
            display: flex;
            border: 1px solid var(--sidebar-border);
            border-radius: 5px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .tab-button {
            flex-grow: 1;
            padding: 0.75rem 0.5rem;
            background-color: var(--button-bg);
            color: #aaa;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .tab-button.active {
            background-color: var(--button-hover-bg);
            color: var(--text-color);
        }

        #sidebar-content {
            padding-top: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .sidebar-section { margin-bottom: 1.5rem; }
        .sidebar-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--text-color);
            padding-bottom: 0.5rem;
        }

        #status-display span, #resource-display span { display: block; margin-bottom: 0.5rem; }
        
        .resource-bar-container {
            width: 100%; height: 10px; background-color: #333; border-radius: 5px; overflow: hidden;
            border: 1px solid var(--sidebar-border); margin-top: 4px;
        }
        .resource-bar { height: 100%; transition: width 0.3s ease; }
        #cpu-bar { background-color: #ff9900; }
        #ram-bar { background-color: #33ccff; }
        #heat-bar { width: 0%; height: 100%; background-color: var(--error-color); transition: width 0.5s ease; }
        #heat-bar-container { height: 20px; }


        .shop-item, .faction-item, .theme-item {
            margin-bottom: 1rem; padding: 0.5rem; background-color: #2a2a2a; border-radius: 4px;
        }
        .shop-item p, .faction-item p, .theme-item p {
            margin: 0 0 0.5rem 0; font-size: 0.9em; color: #ccc;
        }
        .shop-item button, .faction-item button, .theme-item button {
            width: 100%; padding: 0.5rem; background-color: var(--button-bg); color: var(--text-color);
            border: 1px solid var(--text-color); border-radius: 4px; cursor: pointer; font-family: inherit;
        }
        .shop-item button:hover, .faction-item button:hover, .theme-item button:hover { background-color: var(--button-hover-bg); }
        .shop-item button:disabled, .faction-item button:disabled, .theme-item button:disabled {
            background-color: var(--button-disabled-bg); color: var(--button-disabled-color);
            border-color: var(--button-disabled-color); cursor: not-allowed;
        }
        .owned-item { color: var(--highlight-color); font-weight: bold; }
        
        .news-item {
            font-size: 0.9em;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid;
            background-color: rgba(255,255,255,0.05);
        }
        .news-item.white-hat { border-color: var(--whitehat-color); }
        .news-item.black-hat { border-color: var(--blackhat-color); }


        .error { color: var(--error-color); }
        .white-hat { color: var(--whitehat-color); }
        .black-hat { color: var(--blackhat-color); }
        .highlight {
            background-color: var(--text-color);
            color: var(--background-color);
            padding: 0 4px;
        }
    </style>
</head>
<body>

<div id="main-container">
    <div id="terminal-container">
        <div id="terminal">
            <div id="output"></div>
            <div class="input-line">
                <span class="prompt" id="prompt">gray-fox@local:~$</span>
                <input type="text" id="input" autofocus>
                <span class="cursor"></span>
            </div>
        </div>
    </div>
    <div id="sidebar">
        <div id="sidebar-tabs">
            <button class="tab-button active" data-tab="status">Status</button>
            <button class="tab-button" data-tab="shop">Shop</button>
            <button class="tab-button" data-tab="news">News</button>
            <button class="tab-button" data-tab="prefs">Prefs</button>
        </div>
        <div id="sidebar-content">
            <div id="status-panel" class="tab-panel active">
                <div class="sidebar-section">
                    <h3>Vitals</h3>
                    <div id="status-display">
                         <span>💰 Money: $<span id="money">0</span></span>
                         <span>😇 White Hat: <span id="white-hat-rep">0</span></span>
                         <span>😈 Black Hat: <span id="black-hat-rep">0</span></span>
                    </div>
                     <div id="heat-display">
                        <span>Heat Level:</span>
                        <div id="heat-bar-container"><div id="heat-bar"></div></div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3>System Resources</h3>
                    <div id="resource-display">
                        <span>CPU Usage: <span id="cpu-usage">0</span>%</span>
                        <div class="resource-bar-container"><div id="cpu-bar" class="resource-bar"></div></div>
                        <span>RAM Usage: <span id="ram-usage">0</span>%</span>
                        <div class="resource-bar-container"><div id="ram-bar" class="resource-bar"></div></div>
                    </div>
                </div>
            </div>
            <div id="shop-panel" class="tab-panel">
                 <div class="sidebar-section">
                    <h3>Toolkit</h3>
                    <div id="shop-tools"></div>
                </div>
                 <div class="sidebar-section">
                    <h3>Hardware</h3>
                    <div id="shop-hardware"></div>
                </div>
            </div>
            <div id="news-panel" class="tab-panel">
                <div class="sidebar-section">
                    <h3>News Feed</h3>
                    <div id="news-feed"></div>
                </div>
            </div>
            <div id="prefs-panel" class="tab-panel">
                <div class="sidebar-section">
                    <h3>Terminal Themes</h3>
                    <div id="theme-shop"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // --- DOM Elements ---
    const terminal = document.getElementById('terminal');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const promptEl = document.getElementById('prompt');
    const moneyEl = document.getElementById('money');
    const whiteHatRepEl = document.getElementById('white-hat-rep');
    const blackHatRepEl = document.getElementById('black-hat-rep');
    const heatBar = document.getElementById('heat-bar');
    const shopToolsContainer = document.getElementById('shop-tools');
    const shopHardwareContainer = document.getElementById('shop-hardware');
    const newsFeedContainer = document.getElementById('news-feed');
    const themeShopContainer = document.getElementById('theme-shop');
    const cpuUsageEl = document.getElementById('cpu-usage');
    const ramUsageEl = document.getElementById('ram-usage');
    const cpuBar = document.getElementById('cpu-bar');
    const ramBar = document.getElementById('ram-bar');


    // --- Game State ---
    let commandHistory = [];
    let historyIndex = -1;
    let gameState = {
        money: 500,
        whiteHatRep: 0,
        blackHatRep: 0,
        heat: 0,
        currentMission: null,
        inMinigame: false,
        minigameCallback: null,
        resources: {
            cpu: { usage: 0, max: 100 },
            ram: { usage: 0, max: 100 }
        },
        upgrades: {
            cpuLevel: 1,
            ramLevel: 1,
            ownedTools: ['nmap'],
            ownedThemes: ['default'],
            currentTheme: 'default'
        },
        newsFeed: [],
        missions: {}
    };
    // Populate missions from a separate function for clarity
    gameState.missions = getFullMissionList();
    Object.values(gameState.missions).forEach(m => {
        m.mail = getFullMissionDetails(m.id).mail;
    });

    // --- Data Definitions ---
    const toolData = {
        'nmap': { name: 'Nmap Scanner', cost: 0, description: 'Basic network and port scanner.' },
        'metasploit': { name: 'Metasploit Framework', cost: 7500, description: 'Advanced exploit launcher.' },
        'john': { name: 'John the Ripper', cost: 4000, description: 'Powerful password cracker.' },
        'wireshark': { name: 'Wireshark', cost: 3000, description: 'Network traffic analysis tool.' }
    };

    const hardwareData = {
        'cpu2': { name: 'CPU Upgrade (Lvl 2)', cost: 2500, description: 'Increases max CPU by 50.', type: 'upgrade', key: 'cpuLevel', value: 2, resource: 'cpu', increase: 50 },
        'ram2': { name: 'RAM Upgrade (Lvl 2)', cost: 2500, description: 'Increases max RAM by 50.', type: 'upgrade', key: 'ramLevel', value: 2, resource: 'ram', increase: 50 }
    };

    const themeData = {
        'default': { name: 'Gray-Fox Green (Default)', cost: 0, colors: {'--background-color': '#0d0d0d', '--text-color': '#00ff41', '--prompt-color': '#00ff41', '--input-color': '#ffffff'} },
        'whitehat': { name: 'White Hat Blue', cost: 1000, colors: {'--background-color': '#0A192F', '--text-color': '#64FFDA', '--prompt-color': '#5694f7', '--input-color': '#ccd6f6'} },
        'blackhat': { name: 'Black Hat Red', cost: 1000, colors: {'--background-color': '#1a0000', '--text-color': '#ff3333', '--prompt-color': '#ff6666', '--input-color': '#ffcccc'} }
    };
    
    // --- Core Game Logic ---
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const command = input.value.trim();
            if (command) {
                printToOutput(`<span class="prompt">${promptEl.textContent}</span> ${command}`);
                handleCommand(command);
                commandHistory.unshift(command);
                historyIndex = -1;
                input.value = '';
                scrollToBottom();
            }
        } else if (e.key === 'ArrowUp') {
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                input.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            if (historyIndex > 0) {
                historyIndex--;
                input.value = commandHistory[historyIndex];
            } else {
                historyIndex = -1;
                input.value = '';
            }
        }
    });

    terminal.addEventListener('click', () => { input.focus(); });

    function handleCommand(command) {
        const [cmd, ...args] = command.toLowerCase().split(' ');

        if (gameState.resources.cpu.usage > 0 || gameState.resources.ram.usage > 0) {
            printToOutput(`<span class="error">System busy. Please wait for current task to complete.</span>`);
            return;
        }
        if (gameState.inMinigame) {
            if (gameState.minigameCallback) gameState.minigameCallback(command);
            return;
        }

        const toolCommands = ['nmap', 'metasploit', 'john', 'wireshark'];
        if (toolCommands.includes(cmd)) {
            if (!gameState.upgrades.ownedTools.includes(cmd)) {
                printToOutput(`<span class="error">Tool not found: ${cmd}. Purchase it from the shop.</span>`);
                return;
            }
        }

        switch (cmd) {
            case 'help': showHelp(); break;
            case 'clear': output.innerHTML = ''; break;
            case 'whoami': printToOutput('User: gray-fox 🧑‍💻'); break;
            case 'mail': checkMail(); break;
            case 'nmap': runNmap(args[0]); break;
            case 'metasploit': runMetasploit(args[0], args[1]); break;
            case 'social_eng': startSocialEngineeringMinigame(args[0]); break;
            case 'john': startPasswordCrack(args[0]); break;
            default: printToOutput(`<span class="error">Command not found: ${cmd}. Type 'help' for a list of commands.</span>`);
        }
    }
    
    function startTask(cpuCost, ramCost, duration, onStart, onComplete) {
        if (gameState.resources.cpu.usage > 0 || gameState.resources.ram.usage > 0) {
            printToOutput(`<span class="error">System busy.</span>`); return;
        }
        if (gameState.resources.cpu.max < cpuCost || gameState.resources.ram.max < ramCost) {
            printToOutput(`<span class="error">Insufficient resources. Upgrade your hardware.</span>`); return;
        }

        const finalDuration = Math.max(500, duration / gameState.upgrades.cpuLevel);

        gameState.resources.cpu.usage = cpuCost;
        gameState.resources.ram.usage = ramCost;
        updateSidebar();
        onStart();

        setTimeout(() => {
            gameState.resources.cpu.usage = 0;
            gameState.resources.ram.usage = 0;
            updateSidebar();
            onComplete();
        }, finalDuration);
    }

    // --- Command Functions ---
    function showHelp() {
        const helpText = `
Project Gray-Fox Help:
  <span class="highlight">help</span>                 - Shows this help message.
  <span class="highlight">clear</span>                - Clears the terminal screen.
  <span class="highlight">whoami</span>               - Displays your current user.
  <span class="highlight">mail</span>                 - Checks for new missions.

Available Tools (must be purchased):
  <span class="highlight">nmap [ip]</span>            - Scans a target for open ports.
  <span class="highlight">metasploit [vuln] [ip]</span> - Launches an exploit at a target.
  <span class="highlight">john [file]</span>            - Cracks password hashes from a file.
  <span class="highlight">wireshark [ip]</span>         - Monitors network traffic.
  <span class="highlight">social_eng [target]</span>    - Initiates a social engineering attack.
        `;
        printToOutput(helpText.replace(/\n/g, '<br>'));
    }
    
    function checkMail() {
        if (gameState.currentMission) {
            printToOutput("You already have an active mission. Complete it first.");
            return;
        }

        const availableMissions = Object.values(gameState.missions).filter(m => !m.completed);

        if (availableMissions.length === 0) {
            printToOutput("No new messages. You have completed all available missions!");
            return;
        }

        const mission = availableMissions[Math.floor(Math.random() * availableMissions.length)];
        gameState.currentMission = mission.id;
        
        const mailText = `New Message (1):${mission.mail}`;
        typewriterEffect(mailText);
    }
    
    function runNmap(targetIp) {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || !targetIp || targetIp !== mission.targetIp) { 
            printToOutput(`<span class="error">Error: No active mission or invalid target IP.</span>`);
            return;
        }
        
        startTask(40, 20, 5000, 
            () => typewriterEffect(`Running Nmap scan on ${targetIp}...`),
            () => {
                let scanText = `Scan complete. Results:\n`;
                let hint = '';
                if (mission.type === 'sql_injection') {
                    scanText += `  - Port 80/TCP OPEN (HTTP)\n  - Port 443/TCP OPEN (HTTPS)`;
                    hint = `Web server detected. Look for vulnerabilities like SQL Injection on the login page.`;
                } else if (mission.type === 'ransomware') {
                    scanText += `  - Port 445/TCP OPEN (microsoft-ds)`;
                    hint = `Vulnerability found: EternalBlue (MS17-010). Use <span class="highlight">metasploit eternalblue ${targetIp}</span> to exploit.`;
                } else {
                    scanText += `  - No interesting ports found.`;
                }
                typewriterEffect(scanText + `\n\n` + hint);
            }
        );
    }
    
    function runMetasploit(vuln, targetIp) {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || !vuln || !targetIp || targetIp !== mission.targetIp) { 
            printToOutput(`<span class="error">Error: Invalid target or exploit.</span>`);
            return;
        }

        if (mission.type === 'ransomware' && vuln === 'eternalblue') {
            startTask(80, 60, 8000,
                () => typewriterEffect(`Loading Metasploit module for EternalBlue...\nLaunching exploit against ${targetIp}...`),
                () => {
                    typewriterEffect(`
<span class="highlight">Exploit successful!</span> You have a root shell on the target machine.
Now, what's your next move?
  - Report the critical vulnerability to the clinic's IT department. (White Hat)
  - Deploy the ransomware as instructed by the syndicate. (Black Hat)

Type <span class="highlight">report</span> or <span class="highlight">deploy</span>.
                    `);
                    gameState.inMinigame = true;
                    gameState.minigameCallback = (choice) => {
                        gameState.inMinigame = false;
                        gameState.minigameCallback = null;
                        if (choice.toLowerCase() === 'report') {
                            completeMission(2000, 1, 0);
                        } else if (choice.toLowerCase() === 'deploy') {
                            completeMission(50000, 0, 1);
                        } else {
                             printToOutput(`<span class="error">Invalid choice.</span>`);
                        }
                    }
                }
            );
        } else {
            printToOutput(`<span class="error">That exploit is not effective against this target.</span>`);
        }
    }
    
    function startSocialEngineeringMinigame(target) {
        const mission = gameState.missions[gameState.currentMission];
        if (!mission || mission.type !== 'social_engineering') {
            printToOutput(`<span class="error">Error: No active social engineering mission.</span>`);
            return;
        }
        gameState.inMinigame = true;
        const puzzleText = `
--- Social Engineering Minigame ---
You are calling the TechSolutions Help Desk. Your goal is to sound convincing and get the admin password.
The operator answers: "TechSolutions Help Desk, this is Brenda. How can I help you?"

Choose your opening line:
  1) "Hi, I forgot my password. Can you reset it?"
  2) "BRENDA! This is Mark from accounting. The CEO can't login and he is FURIOUS. I need the emergency admin password NOW!"
  3) "Hello, I'm calling for a security audit. I need to verify your current admin password."
Type the number of your choice (1-3) and press Enter.
        `;
        printToOutput(puzzleText.replace(/\n/g, '<br>'));

        gameState.minigameCallback = (choice) => {
            gameState.inMinigame = false;
            gameState.minigameCallback = null;
            if (choice === '2') {
                const successText = `
Brenda sounds flustered. "Oh, oh my! Yes, of course! The emergency password is <span class="highlight">Alpha-Delta-7-7-0</span>. Please tell Mr. Davison we're on it!"

<span class="highlight">Password Acquired!</span>
You've successfully completed the social engineering test.
You hang up and report your findings to CyberRight Inc.
                `;
                typewriterEffect(successText, () => completeMission(7500, 1, 0));
            } else {
                const failText = `
Brenda sounds suspicious. "I'm sorry, I can't do that. I'll need to verify your identity through standard procedure."
<span class="error">She hangs up. Mission failed.</span>
You'll have to wait for another assignment.
                `;
                typewriterEffect(failText, () => completeMission(0, 0, 0, true));
            }
        };
    }


    function completeMission(money, whiteHat, blackHat, sloppy = false) {
        let finalMoney = money;
        let finalHeat = gameState.heat;

        if (whiteHat > 0) {
            if (!sloppy) {
                finalMoney = Math.round(finalMoney * 1.2); // 20% stealth bonus
                printToOutput(`<span class="white-hat">Client impressed with your stealth. Bonus awarded.</span>`);
            }
        }
        if (blackHat > 0) {
            let heatIncrease = sloppy ? 25 : 15;
            if(gameState.upgrades.hasVpn) heatIncrease *= 0.5;
            finalHeat = Math.min(100, finalHeat + heatIncrease);
            if(sloppy) printToOutput(`<span class="error">Your sloppy work attracted attention. Heat increased significantly.</span>`);
        } else {
            finalHeat = Math.max(0, finalHeat - 5);
        }
        
        const news = getNewsHeadline(gameState.currentMission, whiteHat > 0);
        if (news) {
            gameState.newsFeed.unshift({ text: news.headline, type: news.type });
            if (gameState.newsFeed.length > 10) gameState.newsFeed.pop();
        }

        gameState.money += finalMoney;
        gameState.whiteHatRep += whiteHat;
        gameState.blackHatRep += blackHat;
        gameState.heat = finalHeat;
        
        if(gameState.currentMission) {
            gameState.missions[gameState.currentMission].completed = true;
            gameState.currentMission = null;
        }
        
        printToOutput("<br>Mission Completed! Check 'mail' for new assignments.");
        updateSidebar();
        checkHeat();
    }
    
    // --- Sidebar & UI Logic ---
    function setupTabs() {
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;

                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.tab-panel').forEach(panel => {
                    if (panel.id === `${tabName}-panel`) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });
            });
        });
    }

    function updateSidebar() {
        // Vitals & Resources
        moneyEl.textContent = gameState.money.toLocaleString();
        whiteHatRepEl.textContent = gameState.whiteHatRep;
        blackHatRepEl.textContent = gameState.blackHatRep;
        heatBar.style.width = `${gameState.heat}%`;
        cpuUsageEl.textContent = `${gameState.resources.cpu.usage}% of ${gameState.resources.cpu.max}`;
        ramUsageEl.textContent = `${gameState.resources.ram.usage}% of ${gameState.resources.ram.max}`;
        cpuBar.style.width = `${(gameState.resources.cpu.usage / gameState.resources.cpu.max) * 100}%`;
        ramBar.style.width = `${(gameState.resources.ram.usage / gameState.resources.ram.max) * 100}%`;

        // Shop - Tools
        shopToolsContainer.innerHTML = '';
        for (const id in toolData) {
            const item = toolData[id];
            const isOwned = gameState.upgrades.ownedTools.includes(id);
            const canAfford = gameState.money >= item.cost;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            itemDiv.innerHTML = `<strong>${item.name}</strong> ${isOwned ? '<span class="owned-item">[OWNED]</span>' : `- <span class="highlight">$${item.cost.toLocaleString()}</span>`}<p>${item.description}</p>`;
            if (!isOwned) {
                const buyButton = document.createElement('button');
                buyButton.textContent = 'Buy';
                buyButton.disabled = !canAfford;
                buyButton.onclick = () => buyTool(id);
                itemDiv.appendChild(buyButton);
            }
            shopToolsContainer.appendChild(itemDiv);
        }
        // Shop - Hardware
        shopHardwareContainer.innerHTML = '';
        for (const id in hardwareData) {
            const item = hardwareData[id];
            const isOwned = gameState.upgrades[item.key] >= item.value;
            const canAfford = gameState.money >= item.cost;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            itemDiv.innerHTML = `<strong>${item.name}</strong> ${isOwned ? '<span class="owned-item">[OWNED]</span>' : `- <span class="highlight">$${item.cost.toLocaleString()}</span>`}<p>${item.description}</p>`;
             if (!isOwned) {
                const buyButton = document.createElement('button');
                buyButton.textContent = 'Buy';
                buyButton.disabled = !canAfford;
                buyButton.onclick = () => buyHardware(id);
                itemDiv.appendChild(buyButton);
            }
            shopHardwareContainer.appendChild(itemDiv);
        }

        // News Feed
        newsFeedContainer.innerHTML = gameState.newsFeed.map(item => `<div class="news-item ${item.type}">${item.text}</div>`).join('') || '<p>No news yet.</p>';

        // Prefs - Themes
        themeShopContainer.innerHTML = '';
        for (const id in themeData) {
            const item = themeData[id];
            const isOwned = gameState.upgrades.ownedThemes.includes(id);
            const canAfford = gameState.money >= item.cost;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'theme-item';
            itemDiv.innerHTML = `<strong>${item.name}</strong> ${isOwned ? '' : `- <span class="highlight">$${item.cost.toLocaleString()}</span>`}`;
            const actionButton = document.createElement('button');
            if (isOwned) {
                actionButton.textContent = 'Apply';
                actionButton.disabled = gameState.upgrades.currentTheme === id;
                actionButton.onclick = () => applyTheme(id);
            } else {
                actionButton.textContent = 'Buy';
                actionButton.disabled = !canAfford;
                actionButton.onclick = () => buyTheme(id);
            }
            itemDiv.appendChild(actionButton);
            themeShopContainer.appendChild(itemDiv);
        }
    }

    function buyTool(toolId) {
        const item = toolData[toolId];
        if (!item || gameState.money < item.cost) return;
        gameState.money -= item.cost;
        gameState.upgrades.ownedTools.push(toolId);
        printToOutput(`Purchase successful: <span class="highlight">${item.name}</span>`);
        updateSidebar();
    }
    
    function buyHardware(hardwareId) {
        const item = hardwareData[hardwareId];
        if (!item || gameState.money < item.cost) return;
        gameState.money -= item.cost;
        gameState.upgrades[item.key] = item.value;
        gameState.resources[item.resource].max += item.increase;
        printToOutput(`Hardware upgrade successful: <span class="highlight">${item.name}</span>`);
        updateSidebar();
    }
    
    function buyTheme(themeId) {
        const item = themeData[themeId];
        if (!item || gameState.money < item.cost) return;
        gameState.money -= item.cost;
        gameState.upgrades.ownedThemes.push(themeId);
        printToOutput(`Theme unlocked: <span class="highlight">${item.name}</span>`);
        updateSidebar();
    }
    
    function applyTheme(themeId) {
        const theme = themeData[themeId];
        if (!theme) return;
        for (const [key, value] of Object.entries(theme.colors)) {
            document.documentElement.style.setProperty(key, value);
        }
        gameState.upgrades.currentTheme = themeId;
        updateSidebar();
    }

    function checkHeat() {
        if (gameState.heat > 80 && Math.random() < 0.25) {
            typewriterEffect(`<span class="error">** ALERT ** Unusual network traffic detected on your connection! The Feds might be closing in. Lay low for a while.</span>`);
        }
    }

    // --- Helper Functions ---
    function printToOutput(html) {
        output.innerHTML += `<div>${html}</div>`;
        scrollToBottom();
    }

    function scrollToBottom() {
        output.scrollTop = output.scrollHeight;
    }
    
    function typewriterEffect(text, onComplete) {
        const lines = text.replace(/^\n+/, '').replace(/\n/g, '<br>').split('<br>');
        let lineIndex = 0;
        input.disabled = true;

        function printLine() {
            if (lineIndex < lines.length) {
                printToOutput(lines[lineIndex]);
                lineIndex++;
                setTimeout(printLine, 20);
            } else {
                input.disabled = false;
                input.focus();
                if (onComplete) onComplete();
            }
        }
        printLine();
    }

    // --- Game Start & Data Loaders ---
    function startGame() {
        const welcomeMessage = `
Booting Gray-Fox OS v4.1...
Kernel loaded. Resource monitor active.
Network connection secured... OK

Welcome, Gray-Fox 🧑‍💻

Type <span class="highlight">help</span> for a list of available commands.
Type <span class="highlight">mail</span> to check for assignments.
        `;
        setupTabs();
        updateSidebar();
        typewriterEffect(welcomeMessage);
    }
    
    function getNewsHeadline(missionId, isWhiteHat) {
        const mapping = {
            'mission_03': {
                white: null,
                black: { headline: "Innovatech Suffers Major IP Theft, Project Chimera Compromised", type: 'black-hat' }
            },
            'mission_09': {
                white: { headline: "Local Clinic Praises Anonymous Tip for Preventing Cyber-Attack", type: 'white-hat' },
                black: { headline: "Ransomware Attack Cripples Local Clinic, Patient Data at Risk", type: 'black-hat' }
            }
        };
        const missionNews = mapping[missionId];
        if (!missionNews) return null;
        return isWhiteHat ? missionNews.white : missionNews.black;
    }

    function getFullMissionList() {
        return {
            "mission_01":{id:"mission_01",faction:"white",repRequirement:0,type:"sql_injection", targetIp: "192.168.1.101"},
            "mission_02":{id:"mission_02",faction:"white",repRequirement:0,type:"social_engineering"},
            "mission_03":{id:"mission_03",faction:"black",repRequirement:0,type:"data_theft", targetIp: "203.0.113.78"},
            "mission_09":{id:"mission_09",faction:"black",repRequirement:3,type:"ransomware", targetIp: "172.16.30.120"}
        };
    }
    function getFullMissionDetails(id) {
        const mails = {
            "mission_01": { mail: `\nFrom: contact@omnicorp.sec\nTo: gray-fox\nSubject: Urgent: Security Assessment Required\n\nWe require your services for a penetration test on one of our web servers. We suspect a potential vulnerability in our login system.\nTarget IP: <span class="highlight">192.168.1.101</span>\nUse <span class="highlight">nmap</span> to begin your reconnaissance.\n`},
            "mission_02": { mail: `\nFrom: security@cyberright.inc\nTo: gray-fox\nSubject: Contract: Social Engineering Test\n\nGray-Fox, we need you to test the human element at TechSolutions LLC.\nYour task is to acquire an admin password via phone (vishing).\nUse the command <span class="highlight">social_eng TechSolutions_HelpDesk</span> to initiate the call.\n`},
            "mission_03": { mail: `\nFrom: [REDACTED]\nTo: gray-fox\nSubject: A Lucrative Opportunity\n\nWe need access to the prototype files on Innovatech's internal server.\nTheir security is weak. Get in, get the files, get out.\nIP: <span class="highlight">203.0.113.78</span>\nDiscretion is key. Payment will be substantial.\n`},
            "mission_09": { mail: `\nFrom: syndicate-boss@darknet.onion\nTo: gray-fox\nSubject: Job Offer: High Reward\n\nA local clinic has weak security. A perfect target.\nDeploy our ransomware on their server at <span class="highlight">172.16.30.120</span>.\nThe payout will be huge. Use <span class="highlight">nmap</span> to find an entry point.\n`}
        };
        return mails[id] || { mail: "Error: Mail not found." };
    }
    
    // Fill in missing functions from previous steps for completeness
    const unimplemented = () => typewriterEffect(`<span class="error">This tool's function is not yet implemented.</span>`);
    const startPasswordCrack = unimplemented, startBecAttack = unimplemented;
    
    startGame();
</script>
</body>
</html>
